import{g as s,s as e,b as t,d as a,i as o,f as i,l as n,A as r,q as c,w as l,F as h,o as d,p as u,y as f,u as p,x as g,m,z as y,B as _,D as k,L as I,E as x,C as w}from"./index-BrYrmhwU.js";import{r as S,_ as T}from"./uni-notice-bar.BgxRIMtY.js";import{_ as A}from"./search-icon.CtyLh-PK.js";import{_ as C}from"./right.Urk-vgEs.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";const H=""+new URL("ai-icon-Di37X-Ic.png",import.meta.url).href,R=""+new URL("copy-icon-dUAqOBf2.png",import.meta.url).href,v=""+new URL("clear-icon-D3TXjsmc.png",import.meta.url).href,b=""+new URL("bulb-icon-C9fS3ebX.png",import.meta.url).href;const D=M({data:()=>({searchText:"",searchPlaceholder:"例如：艾雅法拉在哪个盒？或 盒1.0有哪些干员？",showSearchSuggestions:!1,aiResponse:"",aiThinking:"",isLoading:!1,responseTime:"",aiModel:"云开发AI助手",showThinking:!1,responseInfo:!1,errorMessage:"",conversationHistory:[],examples:["干员艾雅法拉在哪个盒？","通行证1.0有哪些干员？","凯尔希的盒号是多少？","一共有多少个盒？"],dataUpdateDate:"2024-01-15",cloudInitialized:!1}),onLoad(){console.log("AI搜索页面加载"),this.initCloud(),this.loadHistoryFromStorage(),this.loadDataUpdateDate()},onShow(){this.cloudInitialized||this.initCloud()},methods:{async initCloud(){if(!this.cloudInitialized)try{if(!wx.cloud)return console.error("请使用 2.2.3 或以上的基础库以使用云能力"),void(this.errorMessage="请更新微信版本以使用AI功能");await wx.cloud.init({env:"arknights-series-8fzgq8l473ec963",traceUser:!0}),this.cloudInitialized=!0,console.log("云开发初始化成功")}catch(s){console.error("云开发初始化失败:",s),this.errorMessage="AI服务初始化失败，请稍后重试"}},loadHistoryFromStorage(){try{const e=s("aiConversationHistory");e&&Array.isArray(e)&&(this.conversationHistory=e.slice(0,10))}catch(e){console.error("加载历史记录失败:",e)}},saveHistoryToStorage(s,t){try{const a={question:s,answer:t,time:(new Date).getTime()};this.conversationHistory.unshift(a),this.conversationHistory.length>10&&(this.conversationHistory=this.conversationHistory.slice(0,10)),e("aiConversationHistory",this.conversationHistory)}catch(a){console.error("保存历史记录失败:",a)}},loadDataUpdateDate(){try{const e=s("localUpdateTime");if(e){const s=e.match(/\d{4}-\d{2}-\d{2}/);s&&(this.dataUpdateDate=s[0])}}catch(e){console.error("加载数据更新日期失败:",e)}},onSearchFocus(){this.showSearchSuggestions=!0},onSearchBlur(){setTimeout((()=>{this.showSearchSuggestions=!1}),200)},onSearchInput(){},async handleSearch(){if(this.searchText.trim())if(this.cloudInitialized||(await this.initCloud(),this.cloudInitialized)){this.clearResponse(),this.errorMessage="",this.isLoading=!0,this.responseTime="",this.responseInfo=!1;try{const s=this.searchText.trim();console.log("开始发送问题:",s);const e=Date.now(),a=await this.sendMessageToAI(s),o=(Date.now()-e)/1e3;this.responseTime=`${o.toFixed(1)}秒`,this.saveHistoryToStorage(s,a.content||a),this.responseInfo=!0,t({title:"AI已回答",icon:"success",duration:1500})}catch(s){console.error("AI查询失败:",s),this.errorMessage=this.getErrorMessage(s),t({title:"查询失败",icon:"none"})}finally{this.isLoading=!1}}else t({title:"AI服务未就绪",icon:"none"});else t({title:"请输入问题",icon:"none"})},async sendMessageToAI(s){try{const t=await wx.cloud.extend.AI.bot.sendMessage({data:{botId:"ibot-arknights-ks57pq",msg:s}});let a="",o="";for await(let s of t.eventStream){if("[DONE]"===s.data)break;try{const e=JSON.parse(s.data),t=e.reasoning_content;t&&(o+=t,this.showThinking=!0,this.aiThinking=o);const i=e.content;i&&(a+=i,this.aiResponse=a)}catch(e){console.warn("解析AI响应时出错:",e)}}if(!a)for await(let s of t.textStream)a+=s,this.aiResponse=a;if(!a&&t.result&&(a=t.result.content||JSON.stringify(t.result,null,2),this.aiResponse=a),!a)throw new Error("AI没有返回有效内容");return{content:a,thinking:o}}catch(t){throw console.error("调用AI接口失败:",t),t}},getErrorMessage:s=>s.errMsg?s.errMsg.includes("cloud function not found")?"AI服务暂时不可用，请稍后重试":s.errMsg.includes("network timeout")?"网络超时，请检查网络连接":s.errMsg.includes("not auth")?"未授权访问AI服务":s.errMsg:s.message||"未知错误",useExample(s){this.searchText=s,this.handleSearch()},loadHistory(s){this.searchText=s.question,this.aiResponse=s.answer,this.responseInfo=!0,this.responseTime="历史记录"},clearHistory(){a({title:"确认清除",content:"确定要清除所有历史对话吗？",success:s=>{s.confirm&&(this.conversationHistory=[],o("aiConversationHistory"),t({title:"历史记录已清除",icon:"success"}))}})},clearResponse(){this.aiResponse="",this.aiThinking="",this.showThinking=!1,this.responseInfo=!1,this.isLoading=!1,this.errorMessage=""},copyResponse(){this.aiResponse&&i({data:this.aiResponse,success:()=>{t({title:"已复制到剪贴板",icon:"success"})},fail:s=>{console.error("复制失败:",s),t({title:"复制失败",icon:"none"})}})},retrySearch(){this.errorMessage="",this.handleSearch()},formatTime(s){const e=new Date(s),t=new Date-e;if(t<864e5){if(t<6e4)return"刚刚";if(t<36e5){return`${Math.floor(t/6e4)}分钟前`}return`${Math.floor(t/36e5)}小时前`}return`${e.getMonth()+1}/${e.getDate()} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}}},[["render",function(s,e,t,a,o,i){const M=S(n("uni-notice-bar"),T),D=d,L=k,U=I,q=x,z=w;return u(),r(h,null,[c(D,{class:"header"},{default:l((()=>[c(M,{scrollable:"",single:"",showIcon:"",text:"注意:当前AI模型正在测试当中,故搜索精度很低,且存在大部分角色无法搜出的情况,请您慎重使用!!!"})])),_:1}),c(D,{class:"container"},{default:l((()=>[c(D,{class:"search-section"},{default:l((()=>[c(D,{class:"search-row"},{default:l((()=>[c(D,{class:f(["search-input-container",{focus:o.showSearchSuggestions}])},{default:l((()=>[c(L,{class:"search-icon",src:A}),c(U,{class:"search-input",modelValue:o.searchText,"onUpdate:modelValue":e[0]||(e[0]=s=>o.searchText=s),placeholder:o.searchPlaceholder,onConfirm:i.handleSearch,onFocus:i.onSearchFocus,onBlur:i.onSearchBlur,onInput:i.onSearchInput},null,8,["modelValue","placeholder","onConfirm","onFocus","onBlur","onInput"])])),_:1},8,["class"]),c(q,{class:"search-btn",onClick:i.handleSearch,disabled:o.isLoading},{default:l((()=>[p(g(o.isLoading?"查询中...":"查询"),1)])),_:1},8,["onClick","disabled"])])),_:1})])),_:1}),o.aiResponse||o.isLoading?(u(),m(D,{key:0,class:"ai-response-section"},{default:l((()=>[c(D,{class:"response-header"},{default:l((()=>[c(L,{class:"ai-icon",src:H}),c(z,{class:"response-title"},{default:l((()=>[p("AI助手回答")])),_:1}),c(D,{class:"response-actions"},{default:l((()=>[o.aiResponse?(u(),m(q,{key:0,class:"copy-btn",onClick:i.copyResponse},{default:l((()=>[c(L,{class:"copy-icon",src:R}),p(" 复制 ")])),_:1},8,["onClick"])):y("",!0),o.aiResponse||o.isLoading?(u(),m(q,{key:1,class:"clear-btn",onClick:i.clearResponse},{default:l((()=>[c(L,{class:"clear-icon",src:v}),p(" 清除 ")])),_:1},8,["onClick"])):y("",!0)])),_:1})])),_:1}),c(D,{class:"response-content"},{default:l((()=>[o.isLoading?(u(),m(D,{key:0,class:"loading-container"},{default:l((()=>[c(D,{class:"loading-dots"},{default:l((()=>[c(D,{class:"dot"}),c(D,{class:"dot"}),c(D,{class:"dot"})])),_:1}),c(z,{class:"loading-text"},{default:l((()=>[p("AI正在思考中，请稍候...")])),_:1})])),_:1})):y("",!0),o.aiResponse?(u(),m(D,{key:1,class:"ai-content"},{default:l((()=>[c(z,{class:"ai-text"},{default:l((()=>[p(g(o.aiResponse),1)])),_:1})])),_:1})):y("",!0)])),_:1}),o.showThinking&&o.aiThinking?(u(),m(D,{key:0,class:"thinking-section"},{default:l((()=>[c(z,{class:"thinking-title"},{default:l((()=>[p("AI思考过程：")])),_:1}),c(z,{class:"thinking-content"},{default:l((()=>[p(g(o.aiThinking),1)])),_:1})])),_:1})):y("",!0),o.responseInfo?(u(),m(D,{key:1,class:"response-info"},{default:l((()=>[c(z,{class:"info-text"},{default:l((()=>[p("回答时间："+g(o.responseTime),1)])),_:1}),c(z,{class:"info-text"},{default:l((()=>[p("AI模型："+g(o.aiModel),1)])),_:1})])),_:1})):y("",!0)])),_:1})):y("",!0),o.conversationHistory.length>0&&!o.isLoading?(u(),m(D,{key:1,class:"history-section"},{default:l((()=>[c(D,{class:"history-header"},{default:l((()=>[c(z,{class:"history-title"},{default:l((()=>[p("历史对话")])),_:1}),c(q,{class:"clear-history-btn",onClick:i.clearHistory},{default:l((()=>[p("清除历史")])),_:1},8,["onClick"])])),_:1}),c(D,{class:"history-list"},{default:l((()=>[(u(!0),r(h,null,_(o.conversationHistory,((s,e)=>(u(),m(D,{class:"history-item",key:e,onClick:e=>i.loadHistory(s)},{default:l((()=>[c(z,{class:"history-question"},{default:l((()=>[p(g(s.question),1)])),_:2},1024),c(z,{class:"history-time"},{default:l((()=>[p(g(i.formatTime(s.time)),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})):y("",!0),p(" --\x3e "),0!==o.conversationHistory.length||o.aiResponse?y("",!0):(u(),m(D,{key:2,class:"instructions-section"},{default:l((()=>[c(D,{class:"instruction-card"},{default:l((()=>[c(L,{class:"instruction-icon",src:b}),c(D,{class:"instruction-content"},{default:l((()=>[c(z,{class:"instruction-title"},{default:l((()=>[p("AI助手使用说明")])),_:1}),c(D,{class:"instruction-list"},{default:l((()=>[c(z,{class:"instruction-item"},{default:l((()=>[p("• 可以查询干员所在的盒号")])),_:1}),c(z,{class:"instruction-item"},{default:l((()=>[p("• 可以查询盒内包含的干员")])),_:1}),c(z,{class:"instruction-item"},{default:l((()=>[p("• 支持自然语言提问")])),_:1})])),_:1})])),_:1})])),_:1}),c(D,{class:"example-section"},{default:l((()=>[c(z,{class:"example-title"},{default:l((()=>[p("提问示例：")])),_:1}),c(D,{class:"example-list"},{default:l((()=>[(u(!0),r(h,null,_(o.examples,((s,e)=>(u(),m(D,{class:"example-item",key:e,onClick:e=>i.useExample(s)},{default:l((()=>[c(z,{class:"example-text"},{default:l((()=>[p(g(s),1)])),_:2},1024),c(L,{class:"example-arrow",src:C})])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1})),p(" --\x3e "),o.errorMessage?(u(),m(D,{key:3,class:"error-section"},{default:l((()=>[c(D,{class:"error-content"},{default:l((()=>[c(L,{class:"error-icon",src:"./static/error-icon.png"}),c(z,{class:"error-text"},{default:l((()=>[p(g(o.errorMessage),1)])),_:1})])),_:1}),c(q,{class:"retry-btn",onClick:i.retrySearch},{default:l((()=>[p("重试")])),_:1},8,["onClick"])])),_:1})):y("",!0),c(D,{class:"footer-section"},{default:l((()=>[c(z,{class:"footer-text"},{default:l((()=>[p("本服务由腾讯元器提供")])),_:1}),c(z,{class:"footer-text"},{default:l((()=>[p("内容仅供参考，请仔细甄别")])),_:1}),c(z,{class:"footer-text"},{default:l((()=>[p("数据更新日期："+g(o.dataUpdateDate),1)])),_:1})])),_:1})])),_:1})],64)}],["__scopeId","data-v-dae5c3b9"]]);export{D as default};
