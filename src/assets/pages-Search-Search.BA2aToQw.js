import{I as e,g as a,r as t,s,b as r,n as o,k as c,d as i,m as l,w as n,o as h,p as d,q as u,y as m,u as g,x as f,A as p,B as S,F as y,z as x,t as T,D as _,L as k,J as C,C as b,K as w,E as v}from"./index-BAWL4vNb.js";import{_ as B}from"./search-icon.CtyLh-PK.js";import{_ as E}from"./hot.ChjTii81.js";import{_ as I}from"./empty-icon.8qvP3JRT.js";import{_ as F}from"./_plugin-vue_export-helper.BCo6x5W8.js";const M={clientId:"21680db9b1362913357c",baseUrl:"https://21680db9b1362913357c.myminapp.com/hserve/v2.2",tableNames:{choearth_notice:"choearth_notice",more_notice:"more_notice",Version:"Version",SearchWord_Version:"SearchWord_Version"}};const A=F({data:()=>({searchText:"",searchType:"character",searchResults:[],hasSearched:!1,characterData:[],dataStatusMessage:"",cloudUpdateTime:"",localUpdateTime:"",currentVersion:"",dataUrl:"",defaultAvatar:"/static/default-avatar.png",shouldAutoSearch:!1,filterIndex:0,filterOptions:["全部盒类型","常规款","白名单凭证","特别通行认证","联动款","音律联觉通行证"],filterMap:{0:"all",1:"normal",2:"whitelist",3:"special",4:"cooperation",5:"ambience"},enableEnglishSearch:!1,enableJapaneseSearch:!1,enableNicknameSearch:!1,searchWords:[],customSearchWords:[],builtinNicknames:{"阿米娅":["兔兔","阿米驴","amiya"],"温蒂":["weedy","推推"],"维什戴尔":["ew","EW","WittiDale"],"逻各斯":["李狗剩","Logos"],"星熊":["鬼姐"],"塑心":["阿尔图罗"],"凯尔希":["老猞猁","牢猫"]},showBoxSelectionModal:!1,modalTitle:"",modalBoxList:[],showBoxCharactersModal:!1,currentBoxId:"",modalBoxCharacters:[],showSearchSuggestions:!1,searchSuggestions:[],suggestionsPage:1,suggestionsPageSize:10,suggestionLoadTimer:null,blurTimer:null,favoriteBoxIds:[],favoriteCharacterNames:[],retryCount:0,latestVersion:""}),computed:{searchPlaceholder(){return"character"===this.searchType?"请输入干员名称，如：阿米娅":"请输入盒号，如：1 或 1.0"},currentFilter(){return this.filterMap[this.filterIndex]||"all"},hasEnabledSearchModes(){return this.enableEnglishSearch||this.enableJapaneseSearch||this.enableNicknameSearch},displayedSuggestions(){const e=this.suggestionsPage*this.suggestionsPageSize;return this.searchSuggestions.slice(0,e)},hasMoreSuggestions(){return this.displayedSuggestions.length<this.searchSuggestions.length},isAllSelected(){return 0!==this.modalBoxCharacters.length&&this.modalBoxCharacters.every((e=>this.isFavoriteCharacter(e.name)))}},onLoad(a){e({title:"明日方舟通行证查询工具"}),console.log("页面加载，开始初始化数据..."),a.searchText&&a.searchType&&(this.searchText=decodeURIComponent(a.searchText),this.searchType=a.searchType,this.shouldAutoSearch=!0),this.loadLocalData(),this.loadSearchSettings(),this.loadFavorites(),this.loadSearchWordsFromLocal(),(this.enableEnglishSearch||this.enableNicknameSearch)&&(0===this.searchWords.length?(console.log("本地搜索词数据为空，开始从云端获取"),this.fetchSearchWordsFromCloud()):console.log("使用本地搜索词数据，数量:",this.searchWords.length)),uni.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})},onShow(){if(this.loadSearchSettings(),this.loadFavorites(),this.loadSearchWordsFromLocal(),console.log("Search页面 onShow - 重新加载搜索设置"),this.enableEnglishSearch||this.enableNicknameSearch){const e=a("lastSearchWordsFetch"),t=Date.now();!e||t-e>18e5?this.fetchSearchWordsFromCloud():console.log("搜索词数据在有效期内，使用本地缓存")}},onShareAppMessage(){let e="方舟通行证谷子查询工具-搜索工具",a="/pages/Search/Search";return this.searchText&&this.hasSearched&&("character"===this.searchType?(e=`明日方舟通行证 - ${this.searchText} 所在盒搜索结果`,a=`/pages/Search/Search?searchText=${encodeURIComponent(this.searchText)}&searchType=character`):(e=`明日方舟通行证 - 盒号 ${this.searchText} 干员搜索结果`,a=`/pages/Search/Search?searchText=${encodeURIComponent(this.searchText)}&searchType=box`),this.searchResults.length>0&&(e+=` (${this.searchResults.length}个结果)`)),{title:e,path:a,imageUrl:""}},onShareTimeline:()=>({title:"方舟通行证谷子查询工具-搜索工具",imageUrl:""}),methods:{async knowCloudRequest(e,a={},s=0){if(s>3)throw console.error("知晓云请求重试次数过多"),new Error("知晓云请求重试次数过多");try{const s=M.tableNames[e];if(!s)throw new Error(`未找到表 ${e} 的配置`);let r=`${M.baseUrl}/table/${s}/record/`;if(a.data){const e=[];Object.keys(a.data).forEach((t=>{e.push(`${t}=${encodeURIComponent(a.data[t])}`)})),e.length>0&&(r+=`?${e.join("&")}`)}const o={url:r,method:a.method||"GET",header:{"X-Hydrogen-Client-ID":M.clientId,"Content-Type":"application/json"},timeout:15e3,...a};a.header&&Object.assign(o.header,a.header),console.log("发送知晓云请求:",o.url);const c=await t(o);if(console.log("知晓云响应状态:",c.statusCode),200===c.statusCode)return c.data;throw console.error("知晓云请求错误:",c.statusCode,c.data),new Error(`请求失败: ${c.statusCode}`)}catch(r){if(console.error(`知晓云请求失败 (${e}):`,r),s<3)return console.log(`第${s+1}次重试...`),await this.knowCloudRequest(e,a,s+1);throw r}},async fetchSearchWordsFromCloud(){try{console.log("开始从知晓云获取搜索词数据...");const e=await this.knowCloudRequest("SearchWord_Version",{data:{limit:1e3,offset:0}});if(console.log("知晓云搜索词数据响应:",e),e&&e.objects&&e.objects.length>0){const a=[];e.objects.forEach((e=>{if(!e.name||""===e.name.trim())return;let t=[];if(e.searchword)if(Array.isArray(e.searchword))t=e.searchword;else if("string"==typeof e.searchword)try{const a=JSON.parse(e.searchword);t=Array.isArray(a)?a:e.searchword.split(/[,，、]/).map((e=>e.trim())).filter((e=>e))}catch(r){t=e.searchword.split(/[,，、]/).map((e=>e.trim())).filter((e=>e))}const s={name:e.name.trim(),englishname:(e.englishname||"").trim(),japanesename:(e.japanesename||"").trim(),searchword:t};""===s.englishname&&delete s.englishname,""===s.japanesename&&delete s.japanesename,0===s.searchword.length&&delete s.searchword,a.push(s)})),console.log("处理后的搜索词数据:",a.length,"条"),s("searchWords",a),s("lastSearchWordsFetch",Date.now()),this.searchWords=a,console.log("搜索词数据获取成功，数量:",a.length),setTimeout((()=>{r({title:"搜索词数据已更新",icon:"success",duration:2e3})}),500)}else console.log("未找到搜索词数据或数据格式不正确"),this.loadSearchWordsFromLocal()}catch(e){console.error("从知晓云获取搜索词失败:",e),this.loadSearchWordsFromLocal()}},loadSearchWordsFromLocal(){try{console.log("开始从本地加载搜索词数据...");const e=a("searchWords");if(console.log("从本地存储读取的searchWords:",e),e&&Array.isArray(e)&&e.length>0){this.searchWords=e,console.log("从本地加载搜索词数据成功，数量:",e.length);const a=this.validateSearchWords(e);console.log("有效搜索词数据数量:",a),0===a&&(console.warn("本地搜索词数据格式无效，尝试重新获取"),(this.enableEnglishSearch||this.enableNicknameSearch)&&this.fetchSearchWordsFromCloud())}else console.warn("本地无搜索词数据或数据格式不正确"),this.searchWords=[],(this.enableEnglishSearch||this.enableNicknameSearch)&&(console.log("启用了搜索功能但无本地数据，开始从云端获取"),this.fetchSearchWordsFromCloud())}catch(e){console.error("从本地加载搜索词数据失败:",e),this.searchWords=[]}},validateSearchWords(e){if(!Array.isArray(e))return 0;let a=0;return e.forEach((e=>{e&&e.name&&"string"==typeof e.name&&""!==e.name.trim()&&a++})),a},async getDataUrlFromMinapp(){try{const e=await this.knowCloudRequest("Version",{data:{limit:1,offset:0}});if(console.log("知晓云版本信息响应:",e),e&&e.objects&&e.objects.length>0){const a=e.objects[0];return console.log("版本数据:",a),{url:a.url||"",version:a.version||a.Version||"",cloudUpdateTime:a.updated_at||a.created_at||""}}throw console.error("知晓云返回数据格式不正确:",e),new Error("未找到版本数据或数据格式不正确")}catch(e){throw console.error("从知晓云获取URL失败:",e),e}},onSearchFocus(){this.showSearchSuggestions=!0,this.loadSearchSuggestions(),this.blurTimer&&(clearTimeout(this.blurTimer),this.blurTimer=null)},onSearchBlur(){},onSearchInput(){this.suggestionLoadTimer&&clearTimeout(this.suggestionLoadTimer),this.suggestionLoadTimer=setTimeout((()=>{this.loadSearchSuggestions()}),300)},hideSuggestions(){this.showSearchSuggestions=!1,this.blurTimer&&(clearTimeout(this.blurTimer),this.blurTimer=null)},loadSearchSuggestions(){this.showSearchSuggestions&&(this.suggestionsPage=1,"character"===this.searchType?this.loadCharacterSuggestions():this.loadBoxSuggestions())},loadCharacterSuggestions(){const e=[];if(this.searchWords&&this.searchWords.length>0&&this.searchWords.forEach((a=>{if(a.name){const t={name:a.name,type:"searchWords"};a.englishname&&(t.englishname=a.englishname),a.japanesename&&(t.japanesename=a.japanesename),a.searchword&&Array.isArray(a.searchword)&&a.searchword.length>0&&(t.searchword=a.searchword),e.push(t)}})),this.customSearchWords&&this.customSearchWords.length>0&&this.customSearchWords.forEach((a=>{a.characterName&&e.push({name:a.characterName,words:a.words||[],type:"customSearchWords"})})),Object.keys(this.builtinNicknames).forEach((a=>{e.push({name:a,nicknames:this.builtinNicknames[a],type:"builtinNicknames"})})),this.characterData&&this.characterData.length>0){const a=new Set;this.characterData.forEach((t=>{for(let s=1;s<=10;s++){const r=`character${s}`;if(t[r]){let s="";if("string"==typeof t[r]?s=t[r]:t[r].name&&(s=t[r].name),s&&s.trim()&&!a.has(s)){a.add(s);e.some((e=>e.name===s))||e.push({name:s,type:"characterData"})}}}}))}let a=e;if(this.searchText.trim()){const t=this.searchText.trim().toLowerCase();a=e.filter((e=>{if(e.name.toLowerCase().includes(t))return!0;if(e.englishname&&e.englishname.toLowerCase().includes(t))return!0;if(e.japanesename&&e.japanesename.toLowerCase().includes(t))return!0;if(e.searchword&&Array.isArray(e.searchword))for(const a of e.searchword)if(a.toLowerCase().includes(t))return!0;if(e.words&&Array.isArray(e.words))for(const a of e.words)if(a.toLowerCase().includes(t))return!0;if(e.nicknames&&Array.isArray(e.nicknames))for(const a of e.nicknames)if(a.toLowerCase().includes(t))return!0;return!1}))}const t=[],s=new Set;a.forEach((e=>{s.has(e.name)||(s.add(e.name),t.push(e))})),t.sort(((e,a)=>e.name.localeCompare(a.name,"zh-CN"))),this.searchSuggestions=t},loadBoxSuggestions(){const e=[];if(this.characterData&&this.characterData.length>0){const a=new Set;this.characterData.forEach((t=>{const s=t.Box_id,r=t.Box_type||"normal";s&&!a.has(s)&&(a.add(s),e.push({name:s,boxType:r,type:"boxData"}))}))}let a=e;if(this.searchText.trim()){const t=this.searchText.trim().toLowerCase();a=e.filter((e=>{if(e.name.toLowerCase().includes(t))return!0;return!!this.getBoxTypeText(e.boxType).toLowerCase().includes(t)}))}a.sort(((e,a)=>{const t=e.name.match(/\d+(\.\d+)?/),s=a.name.match(/\d+(\.\d+)?/);return t&&s?parseFloat(t[0])-parseFloat(s[0]):t?-1:s?1:e.name.localeCompare(a.name,"zh-CN")})),this.searchSuggestions=a},selectSuggestion(e){this.searchText=e.name,this.showSearchSuggestions=!1,setTimeout((()=>{this.handleSearch()}),100)},loadMoreSuggestions(){this.suggestionsPage+=1},getSuggestionTypeText:e=>({searchWords:"搜索词",customSearchWords:"自定义",builtinNicknames:"内置外号",characterData:"干员数据",boxData:"盒号数据"}[e]||"未知"),setSearchType(e){this.searchType=e,this.searchResults=[],this.hasSearched=!1,this.searchText="",this.showSearchSuggestions=!1,this.filterIndex=0},onFilterChange(e){this.filterIndex=parseInt(e.detail.value)},handleSearch(){this.searchText.trim()?0!==this.characterData.length?(this.searchResults=[],this.hasSearched=!0,this.showSearchSuggestions=!1,"character"===this.searchType?this.searchByCharacter():this.searchByBox()):r({title:"数据未加载，请先更新数据",icon:"none"}):r({title:"请输入搜索内容",icon:"none"})},searchByCharacter(){const e=this.searchText.trim().toLowerCase(),a={};this.characterData.forEach((t=>{if("all"!==this.currentFilter){const e=t.Box_type||"normal";if("normal"===this.currentFilter){if(e&&"normal"!==e)return}else if(e!==this.currentFilter)return}for(let s=1;s<=10;s++){const r=`character${s}`;if(t[r]){let s="",o="",c=!1,i=!1,l=null;if("string"==typeof t[r]?s=t[r]:t[r].name&&(s=t[r].name,o=t[r].imageUrl||"",c=!0===t[r].nolyELITE1,i=!0===t[r].hotcharacter,l=t[r].market_price||null),s){const r=this.checkCharacterMatch(s,e);r.isMatch&&(a[s]||(a[s]={characterName:s,avatar:o||this.defaultAvatar,boxIds:[],matchType:r.matchType,nolyELITE1:c,hotcharacter:i,market_price:l}),a[s].boxIds.includes(t.Box_id)||a[s].boxIds.push(t.Box_id),a[s].avatar===this.defaultAvatar&&o&&(a[s].avatar=o),!r.matchType||a[s].matchType&&"chinese"!==a[s].matchType||(a[s].matchType=r.matchType),c&&(a[s].nolyELITE1=!0),i&&(a[s].hotcharacter=!0),l&&(a[s].market_price=l))}}}})),this.searchResults=Object.values(a)},syncSearchWordsFromSettings(){console.log("开始同步Settings页面的搜索词数据...");const e=a("searchWords");return console.log("同步获取的searchWords:",e),e&&Array.isArray(e)&&e.length>0?(this.searchWords=e,console.log("成功同步搜索词数据，数量:",e.length),s("lastSearchWordsSync",Date.now()),!0):(console.warn("无法同步搜索词数据，本地存储中无数据"),!1)},checkCharacterMatch(e,a){if(e.toLowerCase().includes(a))return{isMatch:!0,matchType:"chinese"};if(this.enableEnglishSearch||this.enableJapaneseSearch||this.enableNicknameSearch){const t=this.searchWords.find((a=>!(!a||!a.name)&&(a.name===e||a.englishname&&a.englishname.toLowerCase()===e.toLowerCase()||a.japanesename&&a.japanesename===e)));if(t){if(this.enableEnglishSearch&&t.englishname){if(t.englishname.toLowerCase().includes(a))return{isMatch:!0,matchType:"english"}}if(this.enableJapaneseSearch&&t.japanesename){if(t.japanesename.toLowerCase().includes(a))return{isMatch:!0,matchType:"japanese"}}if(this.enableNicknameSearch&&t.searchword){let e=t.searchword;if(Array.isArray(e)||"string"!=typeof e||(e=e.split(/[,，、]/).map((e=>e.trim()))),Array.isArray(e))for(const t of e)if(t&&t.toLowerCase().includes(a))return{isMatch:!0,matchType:"nickname"}}}if(this.enableNicknameSearch&&this.builtinNicknames[e])for(const s of this.builtinNicknames[e])if(s.toLowerCase().includes(a))return{isMatch:!0,matchType:"nickname"};if(this.enableNicknameSearch){const t=this.customSearchWords.find((a=>a.characterName===e));if(t&&t.words&&Array.isArray(t.words))for(const e of t.words)if(e.toLowerCase().includes(a))return{isMatch:!0,matchType:"custom"}}}return{isMatch:!1}},searchByBox(){const e=this.searchText.trim(),a=[],t=e.replace(/\s+/g,"");this.characterData.forEach((s=>{const r=String(s.Box_id||""),o=s.Box_type||"normal";if("all"!==this.currentFilter)if("normal"===this.currentFilter){if(o&&"normal"!==o)return}else if(o!==this.currentFilter)return;let c=!1;if(r===e||r===t)c=!0;else if("normal"!==o&&o){const e=r.match(/^(.+?)(\d+(?:\.\d+)?)$/);if(e){const a=e[1],s=e[2];if([a+s,a+s.replace(".0",""),a+s.split(".")[0]].some((e=>e===t))&&(c=!0),/^\d+(\.\d+)?$/.test(t)){const e=t;[s,s.replace(".0",""),s.split(".")[0]].includes(e)&&"all"!==this.currentFilter&&(c=!0)}}}else{const e=r.match(/^(\d+(?:\.\d+)?)$/);if(e){const a=e[1];[a,a.replace(".0",""),a.split(".")[0]].includes(t)&&(c=!0)}}if(c){const e=[];for(let a=1;a<=10;a++){const t=`character${a}`;if(s[t]){let a="",r="",o=!1,c=!1,i=null;"string"==typeof s[t]?a=s[t]:s[t].name&&(a=s[t].name,r=s[t].imageUrl||"",o=!0===s[t].nolyELITE1,c=!0===s[t].hotcharacter,i=s[t].market_price||null),a&&a.trim()&&e.push({name:a,avatar:r||this.defaultAvatar,nolyELITE1:o,hotcharacter:c,market_price:i})}}a.push({boxId:r,boxType:o,characters:e})}})),this.searchResults=a},getMatchTypeText:e=>({chinese:"中文名",english:"英文名",japanese:"日文名",nickname:"外号",custom:"自定义搜索词"}[e]||"名称"),formatCloudTime(e){if(!e)return"";try{let a;if("number"!=typeof e&&!/^\d+$/.test(e)||10!==e.toString().length&&13!==e.toString().length)a=new Date(e);else{const t=parseInt(e);a=10===t.toString().length?new Date(1e3*t):new Date(t)}return isNaN(a.getTime())?(console.warn("无效的时间格式:",e),"未知时间"):`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")} ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}catch(a){return console.error("格式化云端时间失败:",a,"原始时间:",e),"string"==typeof e?e:"时间格式错误"}},getBoxTypeText:e=>({whitelist:"白名单凭证",special:"特别通行认证",cooperation:"联动款",ambience:"音律联觉通行证",normal:"常规款"}[e]||"常规款"),getBoxTypeClass:e=>({whitelist:"type-whitelist",special:"type-special",cooperation:"type-cooperation",ambience:"type-ambience",normal:"type-normal"}[e]||"type-normal"),onAvatarError(e){this.$set(this.searchResults[e],"avatar",this.defaultAvatar)},onAvatarListError(e,a){this.$set(this.searchResults[e].characters[a],"avatar",this.defaultAvatar)},onModalAvatarError(e){this.$set(this.modalBoxCharacters[e],"avatar",this.defaultAvatar)},loadFavorites(){try{this.favoriteBoxIds=a("favoriteBoxIds")||[],this.favoriteCharacterNames=a("favoriteCharacterNames")||[]}catch(e){this.favoriteBoxIds=[],this.favoriteCharacterNames=[]}},toggleFavorite(e){try{const a=this.favoriteBoxIds.indexOf(e);a>-1?(this.favoriteBoxIds.splice(a,1),r({title:"已取消收藏",icon:"success"})):(this.favoriteBoxIds.push(e),r({title:"收藏成功",icon:"success"})),s("favoriteBoxIds",this.favoriteBoxIds),this.$forceUpdate()}catch(a){r({title:"操作失败",icon:"none"})}},isFavorite(e){return this.favoriteBoxIds.includes(e)},toggleFavoriteCharacter(e){try{const a=this.favoriteCharacterNames.indexOf(e);a>-1?(this.favoriteCharacterNames.splice(a,1),r({title:"已取消收藏",icon:"success"})):(this.favoriteCharacterNames.push(e),r({title:"收藏成功",icon:"success"})),s("favoriteCharacterNames",this.favoriteCharacterNames),this.$forceUpdate()}catch(a){r({title:"操作失败",icon:"none"})}},toggleFavoriteCharacterDirectly(e){this.toggleFavoriteCharacter(e)},isFavoriteCharacter(e){return this.favoriteCharacterNames.includes(e)},selectAllCharacters(){this.isAllSelected?(this.modalBoxCharacters.forEach((e=>{const a=this.favoriteCharacterNames.indexOf(e.name);a>-1&&this.favoriteCharacterNames.splice(a,1)})),r({title:"已取消全选",icon:"success"})):(this.modalBoxCharacters.forEach((e=>{this.favoriteCharacterNames.includes(e.name)||this.favoriteCharacterNames.push(e.name)})),r({title:"已全选",icon:"success"})),s("favoriteCharacterNames",this.favoriteCharacterNames),this.$forceUpdate()},goToBoxInfo(e){o({url:`/pages/box_info/box_info?boxId=${e}`})},handleViewBoxData(e,a){1!==a.length?(this.showBoxSelectionModal=!0,this.modalTitle=`选择 ${e} 所在的盒号`,this.modalBoxList=this.getBoxDetails(a)):this.goToBoxInfo(a[0])},openBoxCharactersModal(e,a){this.showBoxCharactersModal=!0,this.currentBoxId=e,this.modalBoxCharacters=a},hideBoxCharactersModal(){this.showBoxCharactersModal=!1,this.currentBoxId="",this.modalBoxCharacters=[]},getBoxDetails(e){return e.map((e=>{const a=this.characterData.find((a=>a.Box_id===e));if(a){const t=[];for(let e=1;e<=10;e++){const s=`character${e}`;if(a[s]){let e="";"string"==typeof a[s]?e=a[s]:a[s].name&&(e=a[s].name),e&&e.trim()&&t.push({name:e})}}return{boxId:e,boxType:a.Box_type||"normal",characters:t}}return{boxId:e,boxType:"normal",characters:[]}}))},selectBox(e){this.hideBoxSelectionModal(),this.goToBoxInfo(e)},hideBoxSelectionModal(){this.showBoxSelectionModal=!1,this.modalTitle="",this.modalBoxList=[]},loadSearchSettings(){try{const e=a("enableEnglishSearch"),t=a("enableJapaneseSearch"),s=a("enableNicknameSearch"),r=a("customSearchWords");this.enableEnglishSearch="true"===e||!0===e,this.enableJapaneseSearch="true"===t||!0===t,this.enableNicknameSearch="true"===s||!0===s,this.customSearchWords=r||[],console.log("加载搜索设置:",{english:this.enableEnglishSearch,japanese:this.enableJapaneseSearch,nickname:this.enableNicknameSearch,customWordsCount:this.customSearchWords.length})}catch(e){console.error("加载搜索设置失败:",e),this.enableEnglishSearch=!1,this.enableJapaneseSearch=!1,this.enableNicknameSearch=!1,this.customSearchWords=[]}},async loadLocalData(){try{const e=a("arknightsData"),t=a("localUpdateTime"),s=a("cloudUpdateTime"),r=a("dataVersion"),o=a("dataUrl"),c=a("enableGuessData"),i=a("guessData");let l=[];e&&Array.isArray(e)&&e.length>0&&(l=[...e],this.dataStatusMessage=`已加载本地数据 (${e.length} 个盒号)`),"true"===c&&i&&Array.isArray(i)&&i.length>0&&(l=[...l,...i],this.dataStatusMessage+=` + 预测数据 (${i.length} 个盒号)`),l.length>0?(this.characterData=l,this.localUpdateTime=t||"",this.cloudUpdateTime=s||"",this.currentVersion=r||"",this.dataUrl=o||"",this.shouldAutoSearch&&this.characterData.length>0&&setTimeout((()=>{this.handleSearch(),this.shouldAutoSearch=!1}),500),this.currentVersion?setTimeout((()=>{this.checkForUpdates()}),1e3):this.checkForUpdates()):(this.dataStatusMessage="正在获取数据信息...",setTimeout((()=>{this.checkForUpdates()}),2e3))}catch(e){console.error("加载本地数据失败:",e),this.dataStatusMessage="加载本地数据失败，正在尝试获取最新数据...",setTimeout((()=>{this.checkForUpdates()}),2e3)}},async checkForUpdates(){try{this.dataStatusMessage="正在检查更新...";const e=await this.getDataUrlFromMinapp();console.log("获取到的版本信息:",e),this.dataUrl=e.url,this.cloudUpdateTime=e.cloudUpdateTime,this.latestVersion=e.version,s("cloudUpdateTime",this.cloudUpdateTime);const t=a("dataVersion");console.log("本地版本:",t,"云端版本:",this.latestVersion),t&&t===this.latestVersion?(this.currentVersion=t,this.dataStatusMessage=`数据已是最新版本 (${this.currentVersion})`,0===this.characterData.length&&this.downloadData()):this.dataStatusMessage=`发现新版本数据 (${this.latestVersion})，请点击按钮手动更新,更新会消耗一定流量，建议WI-FI下更新`}catch(e){console.error("检查更新失败:",e),this.dataStatusMessage="检查更新失败，使用备用URL",this.dataUrl="https://raw.gitcode.com/huangjinzhou1/ArknightsAuthorization_Series/raw/main/Box_Id.json",this.currentVersion||(this.currentVersion="未知版本"),0===this.characterData.length&&this.downloadData()}},async downloadData(){if(!this.latestVersion)try{const e=await this.getDataUrlFromMinapp();this.dataUrl=e.url,this.latestVersion=e.version,this.cloudUpdateTime=e.cloudUpdateTime||this.cloudUpdateTime}catch(e){console.error("获取数据URL失败:",e),this.dataUrl="https://raw.gitcode.com/huangjinzhou1/ArknightsAuthorization_Series/raw/main/Box_Id.json",this.latestVersion=this.latestVersion||"未知版本"}this.dataUrl||(this.dataUrl="https://raw.gitcode.com/huangjinzhou1/ArknightsAuthorization_Series/raw/main/Box_Id.json"),this.dataStatusMessage="正在下载干员数据...",t({url:this.dataUrl,method:"GET",timeout:15e3,success:e=>{if(200===e.statusCode){let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(a){return console.error("JSON解析失败:",a),void(this.dataStatusMessage="数据格式错误")}if(Array.isArray(t)){const e=t.map((e=>{const a={};for(const t in e)"Box_id"===t?a[t]=String(e[t]||""):t.startsWith("character")?a[t]=e[t]:a[t]=String(e[t]||"");return a}));this.characterData=e,this.currentVersion=this.latestVersion||this.currentVersion||"未知版本",c({key:"arknightsData",data:e,success:()=>{const a=new Date;this.localUpdateTime=`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")} ${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`,c({key:"localUpdateTime",data:this.localUpdateTime}),c({key:"cloudUpdateTime",data:this.cloudUpdateTime}),c({key:"dataVersion",data:this.currentVersion}),c({key:"dataUrl",data:this.dataUrl}),this.dataStatusMessage=`数据更新成功 ${this.currentVersion} (${e.length} 个盒号)`,r({title:"数据更新成功",icon:"success",duration:2e3}),this.shouldAutoSearch&&this.characterData.length>0&&setTimeout((()=>{this.handleSearch(),this.shouldAutoSearch=!1}),500)},fail:e=>{console.error("存储数据失败:",e),this.dataStatusMessage="数据下载成功但存储失败"}})}else this.dataStatusMessage="数据格式不正确"}else this.dataStatusMessage=`服务器错误: ${e.statusCode}`},fail:e=>{console.error("下载数据失败:",e),this.dataStatusMessage="下载失败，请检查网络连接",0===this.characterData.length&&setTimeout((()=>{i({title:"网络错误",content:"无法下载干员数据，请检查网络连接后重试",showCancel:!1})}),500)}})}}},[["render",function(e,a,t,s,r,o){const c=_,i=k,F=h,M=C,A=b,U=w,L=v;return d(),l(F,{class:"container"},{default:n((()=>[u(F,{class:"search-section"},{default:n((()=>[u(F,{class:"search-row"},{default:n((()=>[u(F,{class:m(["search-input-container",{focus:r.showSearchSuggestions}])},{default:n((()=>[u(c,{class:"search-icon",src:B}),u(i,{class:"search-input",modelValue:r.searchText,"onUpdate:modelValue":a[0]||(a[0]=e=>r.searchText=e),placeholder:o.searchPlaceholder,onConfirm:o.handleSearch,onFocus:o.onSearchFocus,onBlur:o.onSearchBlur,onInput:o.onSearchInput},null,8,["modelValue","placeholder","onConfirm","onFocus","onBlur","onInput"])])),_:1},8,["class"]),u(M,{class:"filter-picker",onChange:o.onFilterChange,value:r.filterIndex,range:r.filterOptions},{default:n((()=>[u(F,{class:"picker-text"},{default:n((()=>[g(f(r.filterOptions[r.filterIndex]),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1}),r.showSearchSuggestions&&r.searchSuggestions.length>0?(d(),l(F,{key:0,class:"suggestions-dropdown"},{default:n((()=>[u(U,{class:"suggestions-list","scroll-y":""},{default:n((()=>[(d(!0),p(y,null,S(o.displayedSuggestions,((e,a)=>(d(),l(F,{class:"suggestion-item",key:a,onClick:a=>o.selectSuggestion(e)},{default:n((()=>[u(F,{class:"suggestion-content"},{default:n((()=>[u(A,{class:"suggestion-name"},{default:n((()=>[g(f(e.name),1)])),_:2},1024),u(F,{class:"suggestion-tags"},{default:n((()=>["character"===r.searchType&&e.englishname?(d(),l(A,{key:0,class:"suggestion-tag english"},{default:n((()=>[g("英文名")])),_:1})):x("",!0),"character"===r.searchType&&e.japanesename?(d(),l(A,{key:1,class:"suggestion-tag japanese"},{default:n((()=>[g("日文名")])),_:1})):x("",!0),"character"===r.searchType&&e.searchword&&e.searchword.length>0?(d(),l(A,{key:2,class:"suggestion-tag nickname"},{default:n((()=>[g("外号")])),_:1})):x("",!0),"box"===r.searchType?(d(),l(A,{key:3,class:m(["suggestion-tag",o.getBoxTypeClass(e.boxType)])},{default:n((()=>[g(f(o.getBoxTypeText(e.boxType)),1)])),_:2},1032,["class"])):x("",!0)])),_:2},1024)])),_:2},1024),u(A,{class:"suggestion-type"},{default:n((()=>[g(f(o.getSuggestionTypeText(e.type)),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128)),o.hasMoreSuggestions?(d(),l(F,{key:0,class:"load-more",onClick:o.loadMoreSuggestions},{default:n((()=>[u(A,{class:"load-more-text"},{default:n((()=>[g("加载更多...")])),_:1})])),_:1},8,["onClick"])):x("",!0)])),_:1})])),_:1})):x("",!0),r.showSearchSuggestions?(d(),l(F,{key:1,class:"suggestions-mask",onClick:o.hideSuggestions},null,8,["onClick"])):x("",!0),r.showSearchSuggestions?x("",!0):(d(),l(F,{key:2,class:"search-options"},{default:n((()=>[u(L,{class:m(["option-btn",{active:"character"===r.searchType}]),onClick:a[1]||(a[1]=e=>o.setSearchType("character"))},{default:n((()=>[g(" 按干员名查询盒号 ")])),_:1},8,["class"]),u(L,{class:m(["option-btn",{active:"box"===r.searchType}]),onClick:a[2]||(a[2]=e=>o.setSearchType("box"))},{default:n((()=>[g(" 按盒号查询干员 ")])),_:1},8,["class"])])),_:1})),o.hasEnabledSearchModes&&"character"===r.searchType&&!r.showSearchSuggestions?(d(),l(F,{key:3,class:"search-tips"},{default:n((()=>[u(A,{class:"search-tip-text"},{default:n((()=>[g("已启用: "),r.enableEnglishSearch?(d(),l(A,{key:0,class:"search-tag"},{default:n((()=>[g("英文搜索")])),_:1})):x("",!0),r.enableJapaneseSearch?(d(),l(A,{key:1,class:"search-tag"},{default:n((()=>[g("日文搜索")])),_:1})):x("",!0),r.enableNicknameSearch?(d(),l(A,{key:2,class:"search-tag"},{default:n((()=>[g("外号搜索")])),_:1})):x("",!0)])),_:1})])),_:1})):x("",!0),r.showSearchSuggestions?x("",!0):(d(),l(L,{key:4,class:"search-btn",onClick:o.handleSearch},{default:n((()=>[g("查询")])),_:1},8,["onClick"]))])),_:1}),r.searchResults.length>0?(d(),l(F,{key:0,class:"result-section"},{default:n((()=>[u(F,{class:"result-header"},{default:n((()=>[u(A,{class:"result-title"},{default:n((()=>[g("查询结果")])),_:1}),u(A,{class:"result-count"},{default:n((()=>[g("共找到 "+f(r.searchResults.length)+" 个结果",1)])),_:1})])),_:1}),u(U,{class:"result-list","scroll-y":""},{default:n((()=>[(d(!0),p(y,null,S(r.searchResults,((e,a)=>(d(),l(F,{class:"result-item",key:a},{default:n((()=>["character"===r.searchType?(d(),l(F,{key:0},{default:n((()=>[u(F,{class:"character-result-header"},{default:n((()=>[u(F,{class:"character-with-avatar"},{default:n((()=>[u(F,{class:"character-avatar-container"},{default:n((()=>[u(c,{class:"character-avatar",src:e.avatar,mode:"aspectFit",onError:e=>o.onAvatarError(a)},null,8,["src","onError"]),e.hotcharacter?(d(),l(c,{key:0,class:"hot-character-icon",src:E,mode:"aspectFit"})):x("",!0)])),_:2},1024),u(F,{class:"character-info"},{default:n((()=>[u(F,{class:"character-name-line"},{default:n((()=>[u(A,{class:"label"},{default:n((()=>[g("干员：")])),_:1}),u(A,{class:"value"},{default:n((()=>[g(f(e.characterName),1)])),_:2},1024),e.nolyELITE1?(d(),l(A,{key:0,class:"elite-tag"},{default:n((()=>[g("仅精一")])),_:1})):x("",!0)])),_:2},1024),u(A,{class:"label"},{default:n((()=>[g("所在盒号：")])),_:1}),u(A,{class:"value"},{default:n((()=>[g(f(e.boxIds.join(", ")),1)])),_:2},1024),e.matchType&&"chinese"!==e.matchType?(d(),l(A,{key:0,class:"match-type"},{default:n((()=>[g(" (通过"+f(o.getMatchTypeText(e.matchType))+"匹配) ",1)])),_:2},1024)):x("",!0)])),_:2},1024)])),_:2},1024),u(F,{class:"character-actions"},{default:n((()=>[u(L,{class:m(["favorite-btn",o.isFavoriteCharacter(e.characterName)?"favorited":""]),onClick:a=>o.toggleFavoriteCharacter(e.characterName)},{default:n((()=>[g(f(o.isFavoriteCharacter(e.characterName)?"已收藏":"收藏"),1)])),_:2},1032,["class","onClick"]),u(L,{class:"view-info-btn",onClick:a=>o.handleViewBoxData(e.characterName,e.boxIds)},{default:n((()=>[g(" 查看本盒数据 ")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):x("",!0),"box"===r.searchType?(d(),l(F,{key:1},{default:n((()=>[u(F,{class:"box-header"},{default:n((()=>[u(F,{class:"box-header-left"},{default:n((()=>[u(A,{class:"box-id"},{default:n((()=>[g("盒号 "+f(e.boxId),1)])),_:2},1024),u(A,{class:m(["box-type",o.getBoxTypeClass(e.boxType)])},{default:n((()=>[g(f(o.getBoxTypeText(e.boxType)),1)])),_:2},1032,["class"])])),_:2},1024),u(F,{class:"box-header-right"},{default:n((()=>[u(L,{class:"favorite-btn",onClick:a=>o.openBoxCharactersModal(e.boxId,e.characters)},{default:n((()=>[g(" 收藏 ")])),_:2},1032,["onClick"]),u(L,{class:"view-info-btn",onClick:a=>o.goToBoxInfo(e.boxId)},{default:n((()=>[g(" 查看详情 ")])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024),u(F,{class:"characters-grid"},{default:n((()=>[(d(!0),p(y,null,S(e.characters,((e,t)=>(d(),l(F,{class:"character-card",key:t,onClick:a=>o.toggleFavoriteCharacterDirectly(e.name)},{default:n((()=>[u(F,{class:"character-avatar-container"},{default:n((()=>[u(c,{class:"character-avatar",src:e.avatar,mode:"aspectFit",onError:e=>o.onAvatarListError(a,t)},null,8,["src","onError"]),e.hotcharacter?(d(),l(c,{key:0,class:"hot-character-icon",src:E,mode:"aspectFit"})):x("",!0),u(F,{class:m(["favorite-indicator",o.isFavoriteCharacter(e.name)?"favorited":""])},{default:n((()=>[g(f(o.isFavoriteCharacter(e.name)?"★":"☆"),1)])),_:2},1032,["class"])])),_:2},1024),u(F,{class:"character-info"},{default:n((()=>[u(F,{class:"character-name-line"},{default:n((()=>[u(A,{class:"character-name"},{default:n((()=>[g(f(e.name),1)])),_:2},1024),e.nolyELITE1?(d(),l(A,{key:0,class:"elite-tag"},{default:n((()=>[g("仅精一")])),_:1})):x("",!0)])),_:2},1024),e.market_price?(d(),l(F,{key:0,class:"market-price-tags"},{default:n((()=>[e.market_price.ELITE1?(d(),l(A,{key:0,class:"price-tag elite1-tag"},{default:n((()=>[g(" 精一 "+f(e.market_price.ELITE1)+"元 ",1)])),_:2},1024)):x("",!0),e.market_price.ELITE2&&!e.nolyELITE1?(d(),l(A,{key:1,class:"price-tag elite2-tag"},{default:n((()=>[g(" 精二 "+f(e.market_price.ELITE2)+"元 ",1)])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:2},1024)])),_:2},1024)):x("",!0)])),_:2},1024)))),128))])),_:1})])),_:1})):x("",!0),r.hasSearched&&0===r.searchResults.length?(d(),l(F,{key:1,class:"empty-state"},{default:n((()=>[u(c,{class:"empty-icon",src:I}),u(A,{class:"empty-text"},{default:n((()=>[g("未找到相关结果")])),_:1}),o.hasEnabledSearchModes?(d(),l(A,{key:0,class:"empty-tip"},{default:n((()=>[g("尝试调整搜索词或检查设置中的搜索选项")])),_:1})):x("",!0)])),_:1})):x("",!0),r.dataStatusMessage?(d(),l(F,{key:2,class:"data-status"},{default:n((()=>[u(F,{class:"data-status-main"},{default:n((()=>[u(A,{class:"status-text"},{default:n((()=>[g(f(r.dataStatusMessage),1)])),_:1}),u(F,{class:"data-status-actions"},{default:n((()=>[r.dataStatusMessage&&(r.dataStatusMessage.includes("失败")||r.dataStatusMessage.includes("错误"))?(d(),l(L,{key:0,class:"update-btn small",onClick:o.downloadData},{default:n((()=>[g("重试下载")])),_:1},8,["onClick"])):x("",!0)])),_:1})])),_:1}),r.localUpdateTime||r.cloudUpdateTime||r.currentVersion?(d(),l(F,{key:0,class:"data-details"},{default:n((()=>[r.localUpdateTime?(d(),l(A,{key:0,class:"data-detail-item"},{default:n((()=>[g("本地上次更新: "+f(r.localUpdateTime),1)])),_:1})):x("",!0),r.cloudUpdateTime?(d(),l(A,{key:1,class:"data-detail-item"},{default:n((()=>[g("云端最新更新: "+f(o.formatCloudTime(r.cloudUpdateTime)),1)])),_:1})):x("",!0),r.characterData.length>0?(d(),l(A,{key:2,class:"data-detail-item"},{default:n((()=>[g("当前数据: "+f(r.characterData.length)+" 个盒号",1)])),_:1})):x("",!0),r.currentVersion?(d(),l(A,{key:3,class:"data-detail-item"},{default:n((()=>[g("数据版本: "+f(r.currentVersion),1)])),_:1})):x("",!0)])),_:1})):x("",!0)])),_:1})):x("",!0),u(F,{class:"update-section"},{default:n((()=>[u(L,{class:"update-btn",onClick:o.downloadData},{default:n((()=>[g("更新干员数据")])),_:1},8,["onClick"])])),_:1}),r.showBoxSelectionModal?(d(),l(F,{key:3,class:"image-modal",onClick:o.hideBoxSelectionModal},{default:n((()=>[u(F,{class:"image-modal-content",onClick:a[3]||(a[3]=T((()=>{}),["stop"]))},{default:n((()=>[u(F,{class:"image-modal-header"},{default:n((()=>[u(A,{class:"image-modal-title"},{default:n((()=>[g(f(r.modalTitle),1)])),_:1}),u(L,{class:"close-btn",onClick:o.hideBoxSelectionModal},{default:n((()=>[g("×")])),_:1},8,["onClick"])])),_:1}),u(U,{class:"image-container","scroll-y":""},{default:n((()=>[u(F,{class:"box-selection-list"},{default:n((()=>[(d(!0),p(y,null,S(r.modalBoxList,(e=>(d(),l(F,{class:"box-selection-item",key:e.boxId,onClick:a=>o.selectBox(e.boxId)},{default:n((()=>[u(F,{class:"box-selection-header"},{default:n((()=>[u(F,{class:"box-selection-left"},{default:n((()=>[u(A,{class:"box-selection-id"},{default:n((()=>[g("盒号 "+f(e.boxId),1)])),_:2},1024),u(A,{class:m(["box-selection-type",o.getBoxTypeClass(e.boxType)])},{default:n((()=>[g(f(o.getBoxTypeText(e.boxType)),1)])),_:2},1032,["class"])])),_:2},1024),u(L,{class:m(["favorite-btn-small",o.isFavorite(e.boxId)?"favorited":""]),onClick:T((a=>o.toggleFavorite(e.boxId)),["stop"])},{default:n((()=>[g(f(o.isFavorite(e.boxId)?"★":"☆"),1)])),_:2},1032,["class","onClick"])])),_:2},1024),u(F,{class:"box-selection-characters"},{default:n((()=>[(d(!0),p(y,null,S(e.characters,(e=>(d(),l(A,{class:"box-selection-character",key:e.name},{default:n((()=>[g(f(e.name),1)])),_:2},1024)))),128))])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),u(F,{class:"image-modal-footer"},{default:n((()=>[u(A,{class:"image-tip"},{default:n((()=>[g("请选择要查看的盒号")])),_:1})])),_:1})])),_:1})])),_:1},8,["onClick"])):x("",!0),r.showBoxCharactersModal?(d(),l(F,{key:4,class:"image-modal",onClick:o.hideBoxCharactersModal},{default:n((()=>[u(F,{class:"image-modal-content",onClick:a[5]||(a[5]=T((()=>{}),["stop"]))},{default:n((()=>[u(F,{class:"image-modal-header"},{default:n((()=>[u(A,{class:"image-modal-title"},{default:n((()=>[g("收藏盒号 "+f(r.currentBoxId)+" 内的干员",1)])),_:1}),u(L,{class:"close-btn",onClick:o.hideBoxCharactersModal},{default:n((()=>[g("×")])),_:1},8,["onClick"])])),_:1}),u(U,{class:"image-container","scroll-y":""},{default:n((()=>[u(F,{class:"box-characters-list"},{default:n((()=>[(d(!0),p(y,null,S(r.modalBoxCharacters,((e,a)=>(d(),l(F,{class:"box-character-item",key:a},{default:n((()=>[u(F,{class:"box-character-info"},{default:n((()=>[u(F,{class:"character-avatar-container"},{default:n((()=>[u(c,{class:"character-avatar",src:e.avatar,mode:"aspectFit",onError:e=>o.onModalAvatarError(a)},null,8,["src","onError"]),e.hotcharacter?(d(),l(c,{key:0,class:"hot-character-icon",src:E,mode:"aspectFit"})):x("",!0)])),_:2},1024),u(F,{class:"character-details"},{default:n((()=>[u(F,{class:"character-name-line"},{default:n((()=>[u(A,{class:"character-name"},{default:n((()=>[g(f(e.name),1)])),_:2},1024),e.nolyELITE1?(d(),l(A,{key:0,class:"elite-tag"},{default:n((()=>[g("仅精一")])),_:1})):x("",!0)])),_:2},1024),e.market_price?(d(),l(F,{key:0,class:"market-price-tags"},{default:n((()=>[e.market_price.ELITE1?(d(),l(A,{key:0,class:"price-tag elite1-tag"},{default:n((()=>[g(" 精一 "+f(e.market_price.ELITE1)+"元 ",1)])),_:2},1024)):x("",!0),e.market_price.ELITE2&&!e.nolyELITE1?(d(),l(A,{key:1,class:"price-tag elite2-tag"},{default:n((()=>[g(" 精二 "+f(e.market_price.ELITE2)+"元 ",1)])),_:2},1024)):x("",!0)])),_:2},1024)):x("",!0)])),_:2},1024)])),_:2},1024),u(L,{class:m(["favorite-btn",o.isFavoriteCharacter(e.name)?"favorited":""]),onClick:a=>o.toggleFavoriteCharacter(e.name)},{default:n((()=>[g(f(o.isFavoriteCharacter(e.name)?"已收藏":"收藏"),1)])),_:2},1032,["class","onClick"])])),_:2},1024)))),128))])),_:1})])),_:1}),u(F,{class:"image-modal-footer"},{default:n((()=>[u(F,{class:"modal-footer-actions"},{default:n((()=>[u(L,{class:"select-all-btn",onClick:T(o.selectAllCharacters,["stop"])},{default:n((()=>[g(f(o.isAllSelected?"取消全选":"全选"),1)])),_:1},8,["onClick"]),u(L,{class:m(["favorite-box-btn",o.isFavorite(r.currentBoxId)?"favorited":""]),onClick:a[4]||(a[4]=T((e=>o.toggleFavorite(r.currentBoxId)),["stop"]))},{default:n((()=>[g(f(o.isFavorite(r.currentBoxId)?"已收藏本盒":"收藏本盒"),1)])),_:1},8,["class"])])),_:1}),u(A,{class:"image-tip"},{default:n((()=>[g("点击干员右侧的收藏按钮进行收藏")])),_:1})])),_:1})])),_:1})])),_:1},8,["onClick"])):x("",!0)])),_:1})}],["__scopeId","data-v-4405f21a"]]);export{A as default};
